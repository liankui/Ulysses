# 第5章_与HTTP协作的Web服务器

等闲变却故人心，却道故人心易变。

## 1 单台虚拟机实现多个域名

 一台HTTP服务器可使用虚拟机（Virtual Host）搭建多个Web站点。

在互联网上，域名通过DNS服务映射到IP地址（域名解析）之后访问目标网站。当请求发送到服务器时，已经是以IP地址形式访问了。

在相同的IP地址下，由于虚拟主机可以寄存多个不同主机名和域名的Web网站，因此发送HTTP请求时，必须在Host首部内完整指定主域名的URI。

## 2 通讯数据转发程序

### 2.1 代理

代理是一种有转发功能的应用程序。扮演了位于服务器和客户端”中间人“的角色。

代理服务器的基本行为就是接收客户端发送的请求后转发给其他服务器。

每次通过代理服务器转发请求或响应时，会追加写入Via首部信息。

|        |                                          |                        |                                  |                        |                                        |          |
| ------ | ---------------------------------------- | ---------------------- | -------------------------------- | ---------------------- | -------------------------------------- | -------- |
|        | GET / HTTP1.1                            |                        | GET / HTTP1.1<br />Via：proxy1   |                        | GET / HTTP1.1<br />Via：proxy2，proxy1 |          |
| 客户端 | ————》<br />《————                       | 代理服务器<br />proxy1 | ————》<br />《————               | 代理服务器<br />proxy2 | ————》<br />《————                     | 源服务器 |
|        | HTTP/1.1 200 OK<br />Via：proxy2，proxy1 |                        | HTTP/1.1 200 OK<br />Via：proxy2 |                        | HTTP/1.1 200 OK                        |          |

使用代理的理由：

* 利用缓存技术较少网络带宽的流量；
* 组织内部针对特定网站的访问控制，以获取访问日志为主要目的；
* 等等

代理的使用方法分2类：

* 是否使用缓存；
* 是否会修改报文。

#### 2.1.1 缓存代理

代理转发响应时，缓存代理（Caching Proxy）会预先将资源的副本（缓存）保存在代理服务器上。

当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获取资源，而是将之前缓存的资源作为响应返回。

#### 2.1.2 透明代理

转发请求或响应时，不对报文做任何加工的代理类型被称为透明代理（Transparent Proxy）；反之，对报文内容进行加工的代理被称为非透明代理。

### 2.2 网关

网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。

网关工作机制和代理很相似，而网关能使通信线路上的服务器提供**非HTTP协议服务**。

利用网关能提高**通信的安全性**，可以在客户端与网关之间的通信线路上加密以确保连接的安全。

### 2.3 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。

隧道的目的是确保客户端能服务器进行安全的通信。

隧道本身不回去解析HTTP请求。

## 3 保存资源的缓存

缓存时至代理服务器或客户端本地磁盘内保存的资源副本。利用缓存可减少对源服务器的访问，因此节省了通信流量和通信时间。

缓存服务器时代理服务器中的一种。当代理转发从服务器返回的响应时，代理服务器将会爆粗一份资源的副本。

### 3.1 缓存的有效期限

若缓存过期，需要向源服务器确定资源的有效性，若缓存失效，会再次请求获取新资源。

### 3.2 客户端的缓存

缓存不仅可以存在与缓存服务器内，还可以存在客户端浏览器中。在IE中，会把客户端缓存称为临时网络文件（Temporary Internet File）。

浏览器缓存如果有效，就不必再向服务器请求相同的资源了，可以直接从本地磁盘内获取。